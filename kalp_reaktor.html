<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dilara Interface Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --primary: #ff0055;
            --bg: #000000;
        }

        body {
            margin: 0;
            background-color: var(--bg);
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none; /* Empêche le zoom tactile */
        }

        #container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }

        /* UI Overlay */
        .ui-layer {
            position: absolute; z-index: 10; width: 100%; pointer-events: none;
        }

        /* Scanlines style rétro */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none; z-index: 5;
        }

        /* Header (Haut) */
        #header {
            top: 20px; left: 0; text-align: center;
            color: var(--primary); text-shadow: 0 0 10px var(--primary);
        }
        #header h1 { font-size: 1.2rem; margin: 0; letter-spacing: 3px; }
        #header p { font-size: 0.7rem; margin: 5px 0 0 0; opacity: 0.8; }

        /* Footer (Bas) - Status */
        #footer {
            bottom: 20px; left: 0; width: 100%; text-align: center;
            font-size: 0.8rem; color: white;
        }
        .status-dot {
            display: inline-block; width: 10px; height: 10px; background: red;
            border-radius: 50%; margin-right: 5px;
            box-shadow: 0 0 5px red; transition: all 0.3s;
        }

        /* PIP (Camera Preview) - Petit en bas à droite */
        #pip-container {
            position: absolute; bottom: 20px; right: 20px;
            width: 80px; height: 100px;
            border: 1px solid var(--primary);
            border-radius: 5px;
            overflow: hidden;
            z-index: 20;
            background: rgba(0,0,0,0.5);
        }
        #pip-canvas {
            width: 100%; height: 100%;
            transform: scaleX(-1); /* Miroir */
            opacity: 0.7;
        }

        /* Écran de démarrage (Obligatoire sur mobile pour le son/vidéo) */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; color: white;
        }
        
        .start-btn {
            background: transparent; border: 2px solid var(--primary);
            color: var(--primary); padding: 15px 30px;
            font-size: 1rem; font-family: inherit; font-weight: bold;
            border-radius: 30px; margin-top: 20px;
            box-shadow: 0 0 15px var(--primary);
            pointer-events: auto; cursor: pointer;
        }

        /* Vidéo cachée (Critique: playsinline pour iOS) */
        video { display: none; }
    </style>
</head>
<body>

    <div id="start-screen">
        <div style="font-size: 3rem;">❤️</div>
        <h2>INTERFACE MOBILE</h2>
        <p style="font-size: 0.8rem; padding: 0 20px; color: #aaa;">
            Pour Dilara<br>Utilise la caméra avant pour interagir.
        </p>
        <button class="start-btn" onclick="startApp()">INITIALISER</button>
    </div>

    <div id="container"></div>
    <div class="scanlines"></div>

    <div id="header" class="ui-layer">
        <h1>PROJET DILARA</h1>
        <p>- COEUR HOLOGRAPHIQUE -</p>
    </div>

    <div id="footer" class="ui-layer">
        <div>
            <span id="status-dot" class="status-dot"></span>
            <span id="status-text">EN ATTENTE...</span>
        </div>
    </div>

    <div id="pip-container">
        <canvas id="pip-canvas"></canvas>
    </div>

    <video id="webcam-video" playsinline muted autoplay></video>

    <script>
        // --- CONFIGURATION MOBILE ---
        const CONFIG = {
            particleCount: 6000, // Réduit pour mobile (vs 18k sur PC)
            color: 0xff0055,
            scaleMobile: 1.5 // Zoom par défaut plus gros sur mobile
        };

        let scene, camera, renderer, particles, geometry;
        const targetPositions = [];
        let expansionFactor = 1.0;
        let pulseTime = 0;
        let isStarted = false;

        // --- THREE.JS ---
        function initThree() {
            const container = document.getElementById('container');
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.003);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Adaptation de la caméra selon la largeur de l'écran (Portrait vs Paysage)
            if (window.innerWidth < 600) {
                camera.position.z = 110; // On recule sur mobile portrait
            } else {
                camera.position.z = 70;
            }

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limite densité pixels pour perfs
            container.appendChild(renderer.domElement);

            // Création Texture "Glow"
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(16,16,0,16,16,16);
            grad.addColorStop(0, 'rgba(255,255,255,1)');
            grad.addColorStop(0.4, 'rgba(255,0,85,1)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,32,32);
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

            // Géométrie Coeur
            geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(CONFIG.particleCount * 3);

            for(let i=0; i<CONFIG.particleCount; i++) {
                const ix = i*3;
                
                // Formule Mathématique Coeur
                const t = Math.random() * Math.PI * 2; // Angle
                const phi = Math.random() * Math.PI;   // Volume
                
                // Base 2D
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                
                // Ajout volume 3D
                let z = (Math.random() - 0.5) * 10;
                
                // Variation pour "gonfler" le coeur
                const scale = 1.8;
                const density = Math.random();

                targetPositions[ix] = x * scale * density;
                targetPositions[ix+1] = y * scale * density;
                targetPositions[ix+2] = z * scale * density;

                // Position départ (Explosion)
                positions[ix] = (Math.random()-0.5) * 200;
                positions[ix+1] = (Math.random()-0.5) * 200;
                positions[ix+2] = (Math.random()-0.5) * 200;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const material = new THREE.PointsMaterial({
                color: CONFIG.color,
                size: window.innerWidth < 600 ? 1.5 : 1.0, // Points plus gros sur mobile
                map: texture,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            animate();
        }

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            // Rotation douce
            if(particles) {
                particles.rotation.y += 0.003;
                
                const positions = geometry.attributes.position.array;
                
                for(let i=0; i<CONFIG.particleCount; i++) {
                    const ix = i*3;
                    
                    const tx = targetPositions[ix] * expansionFactor;
                    const ty = targetPositions[ix+1] * expansionFactor;
                    const tz = targetPositions[ix+2] * expansionFactor;

                    // Interpolation (Mouvement fluide)
                    positions[ix] += (tx - positions[ix]) * 0.08;
                    positions[ix+1] += (ty - positions[ix+1]) * 0.08;
                    positions[ix+2] += (tz - positions[ix+2]) * 0.08;
                }
                geometry.attributes.position.needsUpdate = true;
            }

            renderer.render(scene, camera);
        }

        // --- VISION (MEDIAPIPE) ---
        function initCamera() {
            const videoElement = document.getElementById('webcam-video');
            const pipCanvas = document.getElementById('pip-canvas');
            const pipCtx = pipCanvas.getContext('2d');
            
            // UI Elements
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            // Mode optimisé pour mobile (Lite = 0)
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 0, // 0 = Lite (Rapide), 1 = Full (Précis)
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults((results) => {
                // 1. Dessin PIP
                pipCtx.save();
                pipCtx.clearRect(0, 0, pipCanvas.width, pipCanvas.height);
                pipCtx.drawImage(results.image, 0, 0, pipCanvas.width, pipCanvas.height);
                if (results.multiHandLandmarks) {
                    for (const landmarks of results.multiHandLandmarks) {
                        drawConnectors(pipCtx, landmarks, HAND_CONNECTIONS, {color: '#00ff00', lineWidth: 1});
                    }
                }
                pipCtx.restore();

                // 2. Logique Interaction
                if (results.multiHandLandmarks.length === 2) {
                    // Deux mains détectées
                    statusDot.style.background = '#00ff00';
                    statusDot.style.boxShadow = '0 0 10px #00ff00';
                    statusText.innerText = "CONNEXION ÉTABLIE";
                    statusText.style.color = "#00ff00";

                    // Calcul distance index
                    const h1 = results.multiHandLandmarks[0][8];
                    const h2 = results.multiHandLandmarks[1][8];
                    const dist = Math.sqrt(Math.pow(h1.x - h2.x, 2) + Math.pow(h1.y - h2.y, 2));

                    // Scale factor (Sensibilité ajustée pour mobile)
                    let targetScale = dist * 5.0; 
                    if(targetScale < 0.8) targetScale = 0.8;
                    if(targetScale > 3.5) targetScale = 3.5;
                    
                    expansionFactor = targetScale;

                } else if(results.multiHandLandmarks.length === 1) {
                    statusDot.style.background = 'orange';
                    statusText.innerText = "1 MAIN DÉTECTÉE";
                    statusText.style.color = "orange";
                    expansionFactor = 1.0;
                } else {
                    statusDot.style.background = 'red';
                    statusDot.style.boxShadow = 'none';
                    statusText.innerText = "RECHERCHE SIGNAL...";
                    statusText.style.color = "white";

                    // Battement automatique
                    pulseTime += 0.08;
                    expansionFactor = 1.0 + Math.sin(pulseTime) * 0.15;
                }
            });

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 320,  // Basse résolution suffisante pour mobile
                height: 240,
                facingMode: 'user' // Caméra Selfie
            });

            cameraUtils.start();
        }

        // --- GESTION DU START ---
        function startApp() {
            if(isStarted) return;
            isStarted = true;
            
            // Cacher l'écran de start
            document.getElementById('start-screen').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('start-screen').style.display = 'none';
            }, 500);

            initThree();
            initCamera();
        }

        // Resize handler
        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                if (window.innerWidth < 600) camera.position.z = 110;
                else camera.position.z = 70;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

    </script>
</body>
</html>
